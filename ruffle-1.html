<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ruffle Emulator Local</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden;
      background: #000;
      display: flex;
      flex-direction: column;
    }
    #controls {
      background: #222;
      color: white;
      padding: 10px;
      text-align: center;
      user-select: none;
      z-index: 10;
    }
    #ruffle-container {
      flex: 1;
      width: 100%;
      height: 100%;
      position: relative;
    }
    ruffle-embed {
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
</head>
<body>

  <div id="controls">
    <input type="file" id="filepicker" accept=".swf" />
    <button id="clearStorage">Clear Saved Progress</button>
    <span id="status"></span>
  </div>

  <div id="ruffle-container"></div>

  <!-- Load local ruffle.js, put ruffle.js in same folder as this HTML -->
  <script src="ruffle.js"></script>
  <script>
    const ruffleContainer = document.getElementById('ruffle-container');
    const filepicker = document.getElementById('filepicker');
    const status = document.getElementById('status');
    const clearStorageBtn = document.getElementById('clearStorage');

    const ruffle = window.RufflePlayer.newest();
    const rufflePlayer = ruffle.createPlayer();
    ruffleContainer.appendChild(rufflePlayer);

    // Storage keys
    const SWF_STORAGE_KEY = "ruffle_swf_data";
    const SO_STORAGE_PREFIX = "ruffle_sharedobject_";

    // Save SWF binary data to localStorage (base64 encoded)
    function saveSWF(data) {
      const base64 = btoa(String.fromCharCode(...data));
      localStorage.setItem(SWF_STORAGE_KEY, base64);
      status.textContent = "SWF saved";
    }

    // Load SWF from localStorage
    function loadSavedSWF() {
      const savedData = localStorage.getItem(SWF_STORAGE_KEY);
      if (savedData) {
        try {
          const binary = Uint8Array.from(atob(savedData), c => c.charCodeAt(0));
          rufflePlayer.load({ data: binary });
          status.textContent = "Loaded saved SWF";
          return true;
        } catch (e) {
          console.error("Error loading saved SWF:", e);
          status.textContent = "Failed to load saved SWF";
        }
      }
      return false;
    }

    // Save SharedObject data for a given name
    function saveSharedObject(name, data) {
      const base64 = btoa(String.fromCharCode(...data));
      localStorage.setItem(SO_STORAGE_PREFIX + name, base64);
      status.textContent = `Saved SharedObject: ${name}`;
    }

    // Load SharedObject data for a given name
    function loadSharedObject(name) {
      const base64 = localStorage.getItem(SO_STORAGE_PREFIX + name);
      if (!base64) return null;
      try {
        const data = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
        status.textContent = `Loaded SharedObject: ${name}`;
        return data;
      } catch (e) {
        console.error("Error loading SharedObject", e);
        return null;
      }
    }

    // Hook into Ruffle's shared object handling
    rufflePlayer.addEventListener("sharedobjectload", event => {
      const soName = event.detail.name;
      const savedSO = loadSharedObject(soName);
      if (savedSO) {
        event.detail.override(savedSO);
        status.textContent = `Injected saved SharedObject: ${soName}`;
      }
    });

    rufflePlayer.addEventListener("sharedobjectsave", event => {
      const soName = event.detail.name;
      const soData = event.detail.data;
      saveSharedObject(soName, soData);
    });

    // Handle file selection
    filepicker.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function() {
        const arrayBuffer = reader.result;
        const uint8Array = new Uint8Array(arrayBuffer);

        rufflePlayer.load({ data: uint8Array });
        saveSWF(uint8Array);
        status.textContent = `Loaded: ${file.name}`;
      };
      reader.readAsArrayBuffer(file);
    });

    // Clear storage button clears SWF + all saved sharedobjects
    clearStorageBtn.addEventListener('click', () => {
      localStorage.removeItem(SWF_STORAGE_KEY);
      Object.keys(localStorage).forEach(key => {
        if (key.startsWith(SO_STORAGE_PREFIX)) localStorage.removeItem(key);
      });
      status.textContent = "All saved progress cleared. Reload page.";
    });

    // Try to load saved SWF on start
    loadSavedSWF();
  </script>

</body>
</html>
